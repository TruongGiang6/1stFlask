<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tìm Sân Bóng - Football Connect</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Be+Vietnam+Pro:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Be Vietnam Pro', sans-serif;
            background-color: #f8f9fa;
        }
        #map {
            height: 100%;
            width: 100%;
            border-radius: 0.5rem;
        }
        .leaflet-popup-content-wrapper {
            border-radius: 0.5rem;
        }
        .leaflet-popup-content {
            margin: 13px 20px;
            font-size: 14px;
            line-height: 1.4;
        }
        .leaflet-popup-content h3 {
            font-weight: 700;
            color: #166534; /* green-700 */
            margin-bottom: 5px;
        }
    </style>
</head>
<body>

    <!-- Navigation Bar -->
    <nav class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
        <div class="container mx-auto px-6 py-3 flex justify-between items-center">
            <a href="{{ url_for('home') }}" class="flex items-center font-bold text-2xl text-green-600">
                <i class="fa-solid fa-futbol text-green-600 text-4xl mr-2"></i>
                <span>Football Connect</span>
            </a>
            <div class="flex items-center space-x-3">
                {% if current_user.is_authenticated %}
                <div class="relative">
                    <button id="user-menu-button" class="flex items-center bg-gray-100 rounded-xl px-4 py-2 space-x-2 text-left hover:bg-gray-200 focus:outline-none transition">
                        <i class="fa-regular fa-user-circle text-green-700 text-2xl"></i>
                        <span class="font-bold text-green-700 text-lg">{{ current_user.username }}</span>
                        <i class="fa-solid fa-chevron-down text-green-700 text-xs ml-2"></i>
                    </button>
                    <div id="user-menu" class="hidden absolute right-0 mt-2 w-full bg-white rounded-md shadow-xl z-50 border border-gray-100">
                        <a href="#" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition"><i class="fa-solid fa-address-card w-6 mr-1 text-center"></i><span>Thông tin</span></a>
                        <a href="{{ url_for('logout') }}" class="flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-green-50 transition"><i class="fa-solid fa-right-from-bracket w-6 mr-1 text-center"></i><span>Đăng xuất</span></a>
                    </div>
                </div>
                {% else %}
                <a href="{{ url_for('home', _anchor='login') }}" class="bg-green-500 text-white font-semibold px-5 py-2 rounded-lg hover:bg-green-600 transition">Đăng nhập</a>
                <a href="{{ url_for('home', _anchor='register') }}" class="bg-green-500 text-white font-semibold px-5 py-2 rounded-lg hover:bg-blue-600 transition">Đăng ký</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
        <h1 class="text-3xl font-bold text-center text-green-700 mb-8">Tìm sân bóng</h1>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Left Column: Filters and Results -->
            <div class="lg:col-span-1 bg-white p-6 rounded-lg shadow-md h-fit">
                <div class="mb-6">
                    <label for="khu-vuc" class="block text-lg font-bold text-gray-800">Chọn khu vực</label>
                    <p class="text-sm text-gray-500 mb-2">Bản đồ sẽ tự động cập nhật theo lựa chọn của bạn.</p>
                    <select id="khu-vuc" class="mt-1 block w-full p-3 border-gray-300 rounded-md shadow-sm focus:ring-green-500 focus:border-green-500 text-base">
                        <option>Tất cả</option>
                        <option>Ba Đình</option>
                        <option>Hoàn Kiếm</option>
                        <option>Đống Đa</option>
                        <option>Cầu Giấy</option>
                        <option>Hai Bà Trưng</option>
                        <option>Thanh Xuân</option>
                        <option>Hà Đông</option>
                        <option>Long Biên</option>
                        <option>Tây Hồ</option>
                        <option>Hoàng Mai</option>
                        <option>Nam Từ Liêm</option>
                        <option>Bắc Từ Liêm</option>
                    </select>
                </div>
                <h2 class="text-xl font-bold text-green-700 mb-4">Các sân trong khu vực</h2>
                <div id="results-list" class="space-y-4 max-h-[60vh] overflow-y-auto pr-2">
                    <!-- Results will be populated by JavaScript -->
                </div>
            </div>

            <!-- Right Column: Map -->
            <div class="lg:col-span-2 rounded-lg shadow-md overflow-hidden h-[80vh]">
                <div id="map"></div>
            </div>
        </div>
    </main>

    <script>
        // Script for User Dropdown Menu
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenu = document.getElementById('user-menu');

        if (userMenuButton) {
            userMenuButton.addEventListener('click', () => {
                userMenu.classList.toggle('hidden');
            });
            window.addEventListener('click', (e) => {
                if (userMenu && !userMenuButton.contains(e.target) && !userMenu.contains(e.target)) {
                    userMenu.classList.add('hidden');
                }
            });
        }

        // --- Map and Filtering Logic ---

        // 1. Data for pitches and districts
        const pitches = {
            "Sân Mỹ Đình": { lat: 21.0288, lng: 105.7611, khuVuc: "Nam Từ Liêm", loaiSan: "Sân 11 người", gia: "1,200,000 VNĐ", sdt: "0912345678" },
            "Sân Cầu Giấy": { lat: 21.0310, lng: 105.7930, khuVuc: "Cầu Giấy", loaiSan: "Sân 7 người", gia: "650,000 VNĐ", sdt: "0987654321" },
            "Sân Hoàng Mai": { lat: 20.9800, lng: 105.8450, khuVuc: "Hoàng Mai", loaiSan: "Sân 7 người", gia: "500,000 VNĐ", sdt: "0911223344" },
            "Sân Tây Hồ": { lat: 21.0700, lng: 105.8220, khuVuc: "Tây Hồ", loaiSan: "Sân 7 người", gia: "600,000 VNĐ", sdt: "0955667788" },
            "Sân VSA": { lat: 20.9950, lng: 105.8150, khuVuc: "Thanh Xuân", loaiSan: "Sân 7 người", gia: "700,000 VNĐ", sdt: "0944556677" },
            "Sân Bách Khoa": { lat: 21.0050, lng: 105.8440, khuVuc: "Hai Bà Trưng", loaiSan: "Sân 11 người", gia: "1,000,000 VNĐ", sdt: "0933445566" },
            "Sân Long Biên": { lat: 21.0400, lng: 105.8800, khuVuc: "Long Biên", loaiSan: "Sân 7 người", gia: "550,000 VNĐ", sdt: "0922334455" }
        };

        const districtCoordinates = {
            "Tất cả": { lat: 21.0278, lng: 105.8342, zoom: 12 },
            "Ba Đình": { lat: 21.0362, lng: 105.8220, zoom: 14 },
            "Hoàn Kiếm": { lat: 21.0287, lng: 105.8502, zoom: 15 },
            "Đống Đa": { lat: 21.0165, lng: 105.8295, zoom: 14 },
            "Cầu Giấy": { lat: 21.0310, lng: 105.7930, zoom: 14 },
            "Hai Bà Trưng": { lat: 21.0050, lng: 105.8440, zoom: 14 },
            "Thanh Xuân": { lat: 20.9950, lng: 105.8150, zoom: 14 },
            "Hà Đông": { lat: 20.9675, lng: 105.7700, zoom: 13 },
            "Long Biên": { lat: 21.0400, lng: 105.8800, zoom: 14 },
            "Tây Hồ": { lat: 21.0700, lng: 105.8220, zoom: 14 },
            "Hoàng Mai": { lat: 20.9800, lng: 105.8450, zoom: 14 },
            "Nam Từ Liêm": { lat: 21.0288, lng: 105.7611, zoom: 14 },
            "Bắc Từ Liêm": { lat: 21.0600, lng: 105.7600, zoom: 14 }
        };

        // 2. Initialize Map
        const map = L.map('map').setView([21.0278, 105.8342], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19,
            attribution: '© <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        const markers = L.layerGroup().addTo(map);

        // 3. DOM Elements
        const khuVucSelect = document.getElementById('khu-vuc');
        const resultsList = document.getElementById('results-list');

        // 4. Functions
        function updateMapAndList() {
            const selectedKhuVuc = khuVucSelect.value;
            
            // Clear previous markers and list
            markers.clearLayers();
            resultsList.innerHTML = '';

            // Center map on the selected district
            const district = districtCoordinates[selectedKhuVuc];
            if (district) {
                map.setView([district.lat, district.lng], district.zoom);
            }

            // Filter and display pitches
            Object.entries(pitches).forEach(([name, data]) => {
                if (selectedKhuVuc === 'Tất cả' || data.khuVuc === selectedKhuVuc) {
                    // Add marker to map
                    const marker = L.marker([data.lat, data.lng]).addTo(markers);
                    marker.bindPopup(`<h3>${name}</h3><p><b>Khu vực:</b> ${data.khuVuc}<br><b>Loại sân:</b> ${data.loaiSan}<br><b>Giá:</b> ${data.gia}<br><b>SĐT:</b> ${data.sdt}</p>`);

                    // Add item to list
                    const listItem = document.createElement('div');
                    listItem.className = 'p-3 bg-gray-50 rounded-md shadow-sm cursor-pointer hover:bg-green-100 hover:shadow-md transition';
                    listItem.innerHTML = `
                        <h3 class="font-bold text-green-700">${name}</h3>
                        <p class="text-sm text-gray-600">${data.khuVuc} | ${data.loaiSan}</p>
                        <p class="text-sm font-semibold text-gray-800">Giá: ${data.gia}</p>
                    `;
                    listItem.addEventListener('click', () => {
                        map.setView([data.lat, data.lng], 16);
                        marker.openPopup();
                    });
                    resultsList.appendChild(listItem);
                }
            });
        }

        // 5. Event Listeners
        khuVucSelect.addEventListener('change', updateMapAndList);

        // Initial load
        window.addEventListener('load', updateMapAndList);

    </script>

</body>
</html>

